<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Debt Tracker — Cyber Arcade</title>
<meta name="theme-color" content="#0a0b1a">
<style>
  /* ============= CYBER-ARCADE THEME ============= */
  :root{
    --ink:#e9f4ff;           /* main text on dark */
    --muted:#9bc2ff;         /* secondary text */
    --edge:#ffffff22;        /* borders */
    --glass:#0b0f26a8;       /* glass panels */
    --card:#0f1331a8;        /* darker glass */
    --accent:#79ffdb;        /* neon mint */
    --accent2:#ff8bff;       /* neon magenta */
    --accent3:#7ab8ff;       /* neon blue */
    --danger:#ff5e6b;        /* neon red */
    --good:#70ffa8;          /* neon green */
    --radius:18px;
    --shadow:0 24px 50px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font:15.5px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:#070915;
    overflow-x:hidden;
  }

  /* Animated background: gradients + subtle grid */
  .bg-grad{
    position:fixed; inset:0; z-index:-3;
    background:
      radial-gradient(1200px 900px at 70% -10%, #6b00ff33 0%, transparent 60%),
      radial-gradient(900px 700px at -10% 20%, #00ffd533 0%, transparent 60%),
      radial-gradient(1100px 900px at 30% 120%, #ff00e633 0%, transparent 60%),
      #070915;
    animation: hue 22s linear infinite;
  }
  @keyframes hue { 0%{filter:hue-rotate(0deg)} 100%{filter:hue-rotate(360deg)} }

  /* Particle layer (canvas) */
  #stars{position:fixed; inset:0; z-index:-2; filter:brightness(1.1) saturate(1.2)}

  /* Floating neon blobs */
  .blob{position:fixed; pointer-events:none; filter:blur(50px); mix-blend-mode:screen; opacity:.28}
  .b1{top:-80px; left:-80px; width:340px; height:340px; background:#79ffdb; border-radius:50%; animation:float 16s ease-in-out infinite}
  .b2{bottom:-120px; right:-100px; width:420px; height:420px; background:#7ab8ff; border-radius:50%; animation:float 20s ease-in-out infinite reverse}
  .b3{top:15%; right:18%; width:280px; height:280px; background:#ff8bff; border-radius:50%; animation:float 24s ease-in-out infinite}
  @keyframes float{ 0%,100%{transform:translate(0,0)} 50%{transform:translate(14px,-10px)} }

  header{
    position:sticky; top:0; z-index:10; backdrop-filter: blur(10px);
    background:linear-gradient(180deg,#0e1130e6 0%, #0b0f26cc 100%);
    border-bottom:1px solid var(--edge);
  }
  header .wrap{
    max-width:1200px; margin:auto; padding:14px 18px;
    display:flex; align-items:center; gap:14px; justify-content:space-between;
  }
  h1{margin:0; font-size:20px; letter-spacing:.4px; font-weight:800}
  .sub{color:var(--muted); font-size:12.5px}

  main{max-width:1200px; margin:18px auto 60px; padding:0 18px}
  .grid{display:grid; gap:16px}
  @media(min-width:1100px){ .grid{ grid-template-columns: 370px 1fr } }

  .card{
    background:linear-gradient(180deg, var(--glass), var(--card));
    border:1px solid var(--edge); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;
  }
  .card h2{margin:0 0 10px; font-size:17px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .split{display:grid; gap:10px; grid-template-columns:1fr}
  @media(min-width:720px){ .split{grid-template-columns:1fr 1fr} }
  label{font-size:12px; color:var(--muted)}

  input[type=text], input[type=number], input[type=date], select, textarea{
    width:100%; padding:10px 12px; border:1px solid var(--edge); border-radius:12px;
    background:#0c1333; color:var(--ink); outline:none;
    transition:border-color .2s, box-shadow .2s, transform .05s;
  }
  input:focus, select:focus, textarea:focus{ border-color:var(--accent3); box-shadow:0 0 0 3px #7ab8ff33 }
  input[type=number]{ text-align:right }
  textarea{ min-height:70px; resize:vertical }

  .btn{
    appearance:none; border:0; cursor:pointer; font-weight:800; letter-spacing:.2px;
    padding:10px 14px; border-radius:12px; color:#07101e;
    background:linear-gradient(180deg, var(--accent), #4affcc);
    box-shadow:0 8px 20px #00ffc22e; transition: transform .06s ease, filter .2s;
  }
  .btn:hover{ filter:saturate(1.15) brightness(1.05) }
  .btn:active{ transform:translateY(1px) }
  .btn.ghost{background:#101739; color:var(--ink); border:1px solid var(--edge)}
  .btn.pink{ background:linear-gradient(180deg, var(--accent2), #ff68ff) ; color:#2b0030 }
  .btn.warn{ background:linear-gradient(180deg, var(--danger), #ff3c54); color:#200008 }
  .btn.small{ padding:7px 10px; font-size:12.5px }

  .pill{
    display:inline-flex; align-items:center; gap:6px; padding:5px 9px; border-radius:999px;
    background:#121942; border:1px solid var(--edge); color:var(--muted); font-size:12px
  }
  .meter{height:10px; border-radius:999px; background:#0e1233; border:1px solid var(--edge); overflow:hidden}
  .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#7affc9,#7ab8ff,#ff8bff); transition:width .6s}

  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid var(--edge); vertical-align:top; text-align:right}
  th:first-child, td:first-child{text-align:left}
  th{color:var(--muted); font-size:12px}
  .nowrap{white-space:nowrap}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace}

  /* Toasts */
  #toast{position:fixed; bottom:18px; left:50%; transform:translateX(-50%); z-index:20}
  .toast{background:#101739; border:1px solid var(--edge); border-radius:999px; padding:10px 14px; color:var(--ink); box-shadow:var(--shadow)}

  /* Confetti canvas */
  #fx{position:fixed; inset:0; pointer-events:none; z-index:30}
</style>
</head>
<body>
  <!-- Animated backdrop -->
  <div class="bg-grad"></div>
  <canvas id="stars"></canvas>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>
  <canvas id="fx"></canvas>

  <header>
    <div class="wrap">
      <div>
        <h1>Debt Tracker <span style="color:var(--accent2)">╳</span> <span style="color:var(--accent)">Cyber Arcade</span></h1>
        <div class="sub">Payoff with style — snowball / avalanche / even, sessions saved locally.</div>
      </div>
      <div class="row">
        <button id="newSessionBtn" class="btn ghost small">New Session</button>
        <select id="sessionSelect" title="Saved sessions"></select>
        <button id="deleteSessionBtn" class="btn warn small" title="Delete current session">Delete</button>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT: Inputs -->
    <section class="card">
      <div class="row" style="align-items:center">
        <h2 style="margin:0">Debts</h2>
        <span class="pill" id="sessionNamePill"></span>
      </div>

      <div class="split">
        <div><label>Name</label><input id="debtName" type="text" placeholder="e.g., Visa 1234"></div>
        <div><label>Balance ($)</label><input id="debtBalance" type="number" min="0" step="0.01"></div>
        <div><label>APR (%)</label><input id="debtApr" type="number" min="0" step="0.01"></div>
        <div><label>Minimum / mo ($)</label><input id="debtMin" type="number" min="0" step="0.01"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="addDebtBtn" class="btn">Add Debt</button>
        <button id="demoSeedBtn" class="btn ghost">Demo Seed</button>
        <span class="pill">APR is annual; interest compounds monthly.</span>
      </div>

      <hr style="border:none;border-top:1px solid var(--edge); margin:14px 0" />

      <h2>Track</h2>
      <div class="split">
        <div>
          <label>Post Payment</label>
          <select id="payDebt"></select>
        </div>
        <div>
          <label>Amount ($)</label>
          <input id="payAmount" type="number" min="0" step="0.01">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="postPaymentBtn" class="btn pink">Add Payment</button>
        <button id="applyMonthlyBtn" class="btn ghost">Apply Monthly Cycle</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--edge); margin:14px 0" />

      <h2>Simulate</h2>
      <div class="split">
        <div><label>Extra budget / month ($)</label><input id="simExtra" type="number" min="0" step="0.01" value="0"></div>
        <div>
          <label>Minimums</label>
          <select id="simFixedMins">
            <option value="yes" selected>Keep mins fixed</option>
            <option value="no">Recompute mins (~1% balance floor)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="runSimBtn" class="btn">Run Simulations</button>
        <button id="exportBtn" class="btn ghost">Export JSON</button>
        <label class="btn ghost" style="position:relative;overflow:hidden">
          Import JSON
          <input id="importInput" type="file" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer">
        </label>
      </div>

      <details style="margin-top:12px">
        <summary style="cursor:pointer;font-weight:700">Payment Log</summary>
        <div style="overflow:auto;margin-top:8px">
          <table id="logTable">
            <thead><tr><th>Date</th><th>Debt</th><th>Amount ($)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </details>
    </section>

    <!-- RIGHT: Data & Visuals -->
    <section class="card">
      <div class="row" style="align-items:center">
        <h2 style="margin:0">Current Debts</h2>
        <span class="pill" id="totalSummary">—</span>
        <span class="pill" id="xpPill" title="Earn XP by paying down balances!">XP: 0</span>
        <div class="right" style="min-width:200px; width:40%">
          <div class="meter"><i id="progressBar"></i></div>
        </div>
      </div>

      <div style="overflow:auto">
        <table id="debtsTable">
          <thead>
            <tr>
              <th>Debt</th><th>Balance ($)</th><th>APR %</th><th>Min / mo ($)</th><th class="nowrap">Updated</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <hr style="border:none;border-top:1px solid var(--edge); margin:14px 0" />

      <h2>Simulated Payoff Timelines</h2>
      <div id="simResults" class="grid" style="grid-template-columns:1fr; gap:14px"></div>
    </section>
  </main>

  <div id="toast"></div>

<script>
(function(){
  /* ========== utility / fx ========== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmtMoney = n => (isNaN(n)?'-':Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const uuid = () => crypto?.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);
  const esc = s => (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const toast = (msg)=>{ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; $('#toast').appendChild(t); setTimeout(()=>t.remove(), 2200); };

  /* star field */
  const starCanvas = document.getElementById('stars');
  const sctx = starCanvas.getContext('2d');
  function resizeStar(){ starCanvas.width=innerWidth; starCanvas.height=innerHeight; }
  let stars=[];
  function initStars(){
    resizeStar();
    const count = Math.floor((innerWidth*innerHeight)/6000);
    stars = Array.from({length:count}, ()=> ({x:Math.random()*innerWidth, y:Math.random()*innerHeight, r:Math.random()*1.6+0.3, v:Math.random()*0.3+0.1}));
  }
  function tickStars(){
    sctx.clearRect(0,0,starCanvas.width, starCanvas.height);
    sctx.fillStyle='#7ab8ff';
    stars.forEach(st=>{
      sctx.globalAlpha = 0.6 + Math.sin((Date.now()/700 + st.x)*0.02)*0.3;
      sctx.beginPath(); sctx.arc(st.x, st.y, st.r, 0, Math.PI*2); sctx.fill();
      st.y += st.v; if(st.y>innerHeight) st.y = -2;
    });
    requestAnimationFrame(tickStars);
  }
  addEventListener('resize', initStars); initStars(); tickStars();

  /* confetti */
  const fx = $('#fx'); const fxc = fx.getContext('2d');
  function confettiBurst(){
    fx.width = innerWidth; fx.height = innerHeight;
    const pieces = Array.from({length:120}, ()=> ({
      x: innerWidth/2, y: innerHeight/3, a: Math.random()*Math.PI*2,
      v: Math.random()*6+3, s: Math.random()*4+2, c: ['#79ffdb','#ff8bff','#7ab8ff','#fff'][Math.floor(Math.random()*4)]
    }));
    let t=0;
    (function step(){
      fxc.clearRect(0,0,fx.width,fx.height);
      pieces.forEach(p=>{
        p.x += Math.cos(p.a)*p.v; p.y += Math.sin(p.a)*p.v + 0.6; p.v*=0.985; p.a += 0.02;
        fxc.fillStyle = p.c; fxc.fillRect(p.x, p.y, p.s, p.s*1.6);
      });
      t++; if(t<120) requestAnimationFrame(step); else fxc.clearRect(0,0,fx.width,fx.height);
    })();
  }

  /* ========== storage (compatible with old tool) ========== */
  const LS_INDEX = 'debtTracker.sessions';
  const LS_PREFIX = 'debtTracker.session.';
  const loadIndex = () => JSON.parse(localStorage.getItem(LS_INDEX)||'[]');
  const saveIndex = (arr) => localStorage.setItem(LS_INDEX, JSON.stringify(arr));
  const loadSession = id => JSON.parse(localStorage.getItem(LS_PREFIX+id) || 'null');
  const saveSession = (id,data) => localStorage.setItem(LS_PREFIX+id, JSON.stringify(data));
  const deleteSession = id => { localStorage.removeItem(LS_PREFIX+id); saveIndex(loadIndex().filter(x=>x.id!==id)); };

  /* ========== state ========== */
  let current = null; // {id, name, created, debts[], log[], xp}
  function newSession(name='My Debts'){
    const id = uuid();
    current = { id, name, created: Date.now(), debts: [], log: [], xp:0 };
    const idx = loadIndex(); idx.unshift({id, name}); saveIndex(idx);
    saveSession(id,current);
    renderSessionPicker(); selectSession(id);
  }
  function selectSession(id){
    current = loadSession(id);
    if(!current){ return; }
    if(current.xp==null) current.xp = 0; // migrate older sessions
    $('#sessionNamePill').textContent = 'Session: ' + current.name;
    renderAll();
  }
  function renameSession(id, name){
    const idx = loadIndex().map(x=> x.id===id ? {...x, name} : x);
    saveIndex(idx);
    current.name = name;
    saveSession(id,current);
    renderSessionPicker();
    $('#sessionNamePill').textContent = 'Session: ' + current.name;
  }

  /* ========== rendering ========== */
  const getDebt = id => current.debts.find(d=>d.id===id);
  function renderSessionPicker(){
    const idx = loadIndex();
    const s = $('#sessionSelect'); s.innerHTML='';
    idx.forEach(({id,name})=>{ const o=document.createElement('option'); o.value=id; o.textContent=name; s.appendChild(o); });
    if(current) s.value = current.id;
  }
  function renderDebts(){
    const tb = $('#debtsTable tbody'); tb.innerHTML='';
    let totalBal=0,totalMin=0,weightedAPR=0, startBal=0;

    current.debts.forEach(d=> startBal += (d.startBalance ?? d.balance));
    current.debts.forEach(d=>{
      totalBal += d.balance;
      totalMin += d.min;
      weightedAPR += d.balance * d.apr;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><span class="mono">${esc(d.name)}</span></td>
        <td>$${fmtMoney(d.balance)}</td>
        <td>${(d.apr*100).toFixed(2)}</td>
        <td>$${fmtMoney(d.min)}</td>
        <td>${d.updated||'-'}</td>
        <td class="nowrap">
          <button class="btn small ghost" data-edit="${d.id}">Edit</button>
          <button class="btn small warn" data-del="${d.id}">Remove</button>
        </td>`;
      tb.appendChild(tr);
    });

    const avgAPR = totalBal>0 ? (weightedAPR/totalBal)*100 : 0;
    $('#totalSummary').textContent = `Total $${fmtMoney(totalBal)} • Mins $${fmtMoney(totalMin)} • Avg APR ${avgAPR.toFixed(2)}%`;

    // payoff progress vs starting sum snapshot
    if(!current._baseline) current._baseline = totalBal || 1;
    const progress = Math.max(0, Math.min(1, 1 - (totalBal / current._baseline)));
    $('#progressBar').style.width = (progress*100).toFixed(1) + '%';

    // debt select for payments
    const sel = $('#payDebt'); sel.innerHTML='';
    current.debts.forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; sel.appendChild(o); });

    // bind edits
    $$('#debtsTable [data-edit]').forEach(b=> b.onclick = ()=> editDebt(b.getAttribute('data-edit')));
    $$('#debtsTable [data-del]').forEach(b=> b.onclick = ()=> removeDebt(b.getAttribute('data-del')));
  }
  function renderLog(){
    const tb=$('#logTable tbody'); tb.innerHTML='';
    (current.log||[]).slice().reverse().forEach(row=>{
      const d = getDebt(row.debtId);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${row.date}</td><td>${d?esc(d.name):'—'}</td><td>$${fmtMoney(row.amount)}</td>`;
      tb.appendChild(tr);
    });
  }
  function renderXP(){
    $('#xpPill').textContent = `XP: ${current.xp|0}`;
  }
  function renderAll(){ renderDebts(); renderLog(); renderXP(); }

  /* ========== debt ops ========== */
  function addDebt(){
    const name=$('#debtName').value.trim();
    const bal=parseFloat($('#debtBalance').value);
    const apr=parseFloat($('#debtApr').value)/100;
    const min=parseFloat($('#debtMin').value);
    if(!name || !(bal>=0) || !(apr>=0) || !(min>=0)){ toast('Enter valid debt details'); return; }
    current.debts.push({ id:uuid(), name, balance:bal, startBalance:bal, apr, min, updated:todayISO() });
    saveSession(current.id,current); renderAll();
    $('#debtName').value=''; $('#debtBalance').value=''; $('#debtApr').value=''; $('#debtMin').value='';
    toast('Debt added ✔');
  }
  function editDebt(id){
    const d=getDebt(id); if(!d) return;
    const name = prompt('Debt name:', d.name); if(name===null) return;
    const bal  = parseFloat(prompt('Current balance ($):', d.balance)); if(!(bal>=0)) return;
    const apr  = parseFloat(prompt('APR %:', (d.apr*100).toFixed(2))); if(!(apr>=0)) return;
    const min  = parseFloat(prompt('Minimum / mo ($):', d.min)); if(!(min>=0)) return;
    d.name=name; d.balance=bal; if(d.startBalance==null) d.startBalance=bal; d.apr=apr/100; d.min=min; d.updated=todayISO();
    saveSession(current.id,current); renderAll(); toast('Debt updated ✎');
  }
  function removeDebt(id){
    if(!confirm('Remove this debt?')) return;
    current.debts = current.debts.filter(d=>d.id!==id);
    saveSession(current.id,current); renderAll(); toast('Debt removed');
  }

  function postPayment(){
    const debtId=$('#payDebt').value;
    const amt=parseFloat($('#payAmount').value);
    if(!debtId || !(amt>0)){ toast('Pick a debt & amount'); return; }
    const d=getDebt(debtId); if(!d){ toast('Debt not found'); return; }
    d.balance = Math.max(0, +(d.balance - amt).toFixed(10));
    d.updated = todayISO();
    (current.log ||= []).push({date: todayISO(), debtId, amount: amt});
    current.xp += Math.round(amt/5); // tiny XP boost
    saveSession(current.id,current); renderAll();
    if(d.balance===0){ confettiBurst(); toast(`🏁 ${d.name} paid off!`); }
    $('#payAmount').value='';
  }

  function applyMonthlyCycle(){
    current.debts.forEach(d=>{
      const i = d.apr/12;
      d.balance = +(d.balance * (1+i)).toFixed(10);
      const pay = Math.min(d.min, d.balance);
      d.balance = +(d.balance - pay).toFixed(10);
      if(pay>0) (current.log ||= []).push({date: todayISO(), debtId: d.id, amount: pay});
      d.updated = todayISO();
    });
    current.xp += 50; // monthly streak bonus
    saveSession(current.id,current); renderAll();
    toast('Monthly cycle applied');
  }

  /* ========== simulation ========== */
  function cloneDebts(){ return current.debts.map(d=> ({id:d.id,name:d.name,balance:+d.balance,apr:+d.apr,min:+d.min})); }
  function simulate(strategy, extraPerMonth, fixedMinimums){
    let debts = cloneDebts().filter(d=> d.balance>0);
    const schedule=[]; let month=0, totalInterest=0;
    const orderFn = { snowball:(a,b)=>a.balance-b.balance, avalanche:(a,b)=>b.apr-a.apr, even:(a,b)=>a.name.localeCompare(b.name) }[strategy];
    const minFloorPct = 0.01, MAX_MONTHS = 1200;
    while(debts.some(d=>d.balance>0) && month<MAX_MONTHS){
      month++;
      debts.forEach(d=> d.curMin = fixedMinimums ? d.min : Math.max(d.min, +(d.balance*minFloorPct).toFixed(2)));
      debts.forEach(d=>{
        const interest = +(d.balance * (d.apr/12)).toFixed(10);
        d.balance = +(d.balance + interest).toFixed(10);
        d.lastInterest = interest; totalInterest += interest;
      });
      debts.forEach(d=>{
        const p = Math.min(d.curMin, d.balance);
        d.balance = +(d.balance - p).toFixed(10);
        d.lastPayment = p;
      });
      let extra = +extraPerMonth;
      let ordered = debts.slice().sort(orderFn);
      if(strategy==='even'){
        const payees=ordered.filter(d=> d.balance>0);
        const each = payees.length ? extra / payees.length : 0;
        payees.forEach(d=>{
          const pay = Math.min(each, d.balance); d.balance = +(d.balance - pay).toFixed(10); d.lastPayment += pay; extra -= pay;
        });
      } else {
        for(const d of ordered){
          if(extra<=0) break; if(d.balance<=0) continue;
          const pay = Math.min(extra, d.balance); d.balance = +(d.balance - pay).toFixed(10); d.lastPayment += pay; extra -= pay;
        }
      }
      schedule.push({
        month,
        rows: debts.map(d=>({
          name:d.name,
          beforeInterest:+(d.balance + d.lastPayment - d.lastInterest).toFixed(2),
          interest:+d.lastInterest.toFixed(2),
          payment:+d.lastPayment.toFixed(2),
          after:+d.balance.toFixed(2)
        }))
      });
      debts = debts.map(d=> ({...d, balance:+d.balance})).filter(d=> d.balance>0.005 ? true : (d.balance=0,false));
    }
    const payoffDate = addMonthsISO(new Date(), month);
    return { months: month, totalInterest, schedule, payoffDate };
  }
  function addMonthsISO(date, m){ const d=new Date(date); d.setMonth(d.getMonth()+m); return d.toISOString().slice(0,10); }

  function runSimulations(){
    if(!current.debts.length){ toast('Add a debt first'); return; }
    const extra = parseFloat($('#simExtra').value)||0;
    const fixed = $('#simFixedMins').value==='yes';
    const sims = [
      {key:'snowball', label:'Snowball (smallest balance first)', color:'#79ffdb'},
      {key:'avalanche', label:'Avalanche (highest APR first)', color:'#ff8bff'},
      {key:'even', label:'Even Split (extra divided equally)', color:'#7ab8ff'}
    ].map(s=> ({...s, result: simulate(s.key, extra, fixed)}));

    const wrap = $('#simResults'); wrap.innerHTML='';
    sims.forEach(sim=>{
      const {months,totalInterest,schedule,payoffDate} = sim.result;
      const years = (months/12).toFixed(2);
      const card=document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="row" style="align-items:center">
          <h3 style="margin:0">${sim.label}</h3>
          <span class="pill">⏳ ${months} mo (${years} yrs)</span>
          <span class="pill">💸 Interest $${fmtMoney(totalInterest)}</span>
          <span class="pill">🏁 ${payoffDate}</span>
          <button class="btn small ghost right" data-dl="${sim.key}">Download CSV</button>
        </div>
        <div style="max-height:300px; overflow:auto; margin-top:8px; border:1px solid var(--edge); border-radius:12px">
          <table>
            <thead><tr><th>Month</th><th>Debt</th><th>Start</th><th>Interest</th><th>Payment</th><th>End</th></tr></thead>
            <tbody>${schedule.map(step=> step.rows.map(r=>`
              <tr><td>${step.month}</td><td>${esc(r.name)}</td><td>${fmtMoney(r.beforeInterest)}</td>
              <td>${fmtMoney(r.interest)}</td><td>${fmtMoney(r.payment)}</td><td>${fmtMoney(r.after)}</td></tr>
            `).join('')).join('')}</tbody>
          </table>
        </div>
      `;
      wrap.appendChild(card);
      card.querySelector('[data-dl]').onclick = ()=> downloadCSV(sim.label, schedule);
    });

    toast('Simulation complete ✨');
  }

  function downloadCSV(title, schedule){
    const rows = [['Month','Debt','Start','Interest','Payment','End']];
    schedule.forEach(step=> step.rows.forEach(r=> rows.push([step.month, r.name, r.beforeInterest, r.interest, r.payment, r.after])));
    const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = title.replace(/\s+/g,'_') + '.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  /* ========== export/import ========== */
  function exportJSON(){
    const payload = { meta:{exportedAt:new Date().toISOString()}, session: current };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = (current.name||'debts') + '.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  function importJSON(file){
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!data.session?.debts) throw new Error('Invalid file.');
        const id = uuid();
        const name = data.session.name ? (data.session.name + ' (import)') : 'Imported Debts';
        const sess = {...data.session, id, name};
        saveSession(id, sess);
        const idx = loadIndex(); idx.unshift({id, name}); saveIndex(idx);
        renderSessionPicker(); selectSession(id);
        toast('Session imported ✅');
      }catch(err){ toast('Import failed: ' + err.message); }
    };
    reader.readAsText(file);
  }

  /* ========== events ========== */
  $('#addDebtBtn').onclick = addDebt;
  $('#demoSeedBtn').onclick = ()=>{
    if(!confirm('Load a demo set? This adds example debts to your session.')) return;
    const samples = [
      {name:'Visa 1234', balance:3200, apr:0.2199, min:65},
      {name:'Car Loan', balance:8900, apr:0.049, min:220},
      {name:'Student Loan A', balance:12500, apr:0.063, min:110}
    ];
    samples.forEach(s=> current.debts.push({id:uuid(), name:s.name, balance:s.balance, startBalance:s.balance, apr:s.apr, min:s.min, updated:todayISO()}));
    saveSession(current.id,current); renderAll(); toast('Demo debts added');
  };
  $('#postPaymentBtn').onclick = postPayment;
  $('#applyMonthlyBtn').onclick = applyMonthlyCycle;
  $('#runSimBtn').onclick = runSimulations;
  $('#exportBtn').onclick = exportJSON;
  $('#importInput').onchange = e=> e.target.files[0] && importJSON(e.target.files[0]);

  $('#newSessionBtn').onclick = ()=>{
    const name = prompt('Name for the new session:','My Debts'); if(name===null) return;
    newSession(name.trim()||'My Debts');
  };
  $('#deleteSessionBtn').onclick = ()=>{
    if(!current) return;
    if(confirm(`Delete session "${current.name}"? This cannot be undone.`)){
      const id=current.id; deleteSession(id);
      const idx=loadIndex();
      if(idx.length){ selectSession(idx[0].id); renderSessionPicker(); }
      else{ current=null; newSession('My Debts'); }
      toast('Session deleted');
    }
  };
  $('#sessionSelect').onchange = e=> selectSession(e.target.value);
  $('#sessionSelect').ondblclick = ()=>{
    if(!current) return;
    const name = prompt('Renamesession:', current.name);
    if (name !== null && name.trim()) renameSession(current.id, name.trim());
  };

  // ---------- bootstrap ----------
  (function init(){
    const idx = loadIndex();
    if (!idx.length) {
      newSession('My Debts');
    } else {
      renderSessionPicker();
      selectSession(idx[0].id);
    }
  })();
})();
</script>
</body>
</html>

